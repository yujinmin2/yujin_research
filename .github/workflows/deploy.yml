# ============================================================
# Notion â†’ Jupyter Book â†’ Deploy Pipeline
# ============================================================
# 
# íŠ¸ë¦¬ê±°:
#   - Push to main: ë¹Œë“œ ë° ë°°í¬
#   - Pull Request: ë¹Œë“œë§Œ (ë¯¸ë¦¬ë³´ê¸°)
#   - Schedule: ë§¤ì¼ ìì • (KST 09:00) Notion ë™ê¸°í™”
#   - Manual: workflow_dispatch
#
# í•„ìš”í•œ Secrets:
#   - NOTION_API_KEY: Notion Integration API í‚¤
#   - NOTION_DATABASE_ID: Lessons DB ID (6bde9e09-8279-46ba-9a29-8e3984f973f9)
#   - NOTION_COURSES_DB_ID: Courses DB ID (31c05592-b009-4418-968f-1d29ff067d7d)
#
# ============================================================

name: ğŸ“š Build & Deploy Jupyter Book

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  schedule:
    # 6ì‹œê°„ë§ˆë‹¤ ì‹¤í–‰ (UTC 0, 6, 12, 18ì‹œ = KST 9, 15, 21, 03ì‹œ)
    - cron: '0 */6 * * *'
  workflow_dispatch:
    inputs:
      sync_notion:
        description: 'Notionì—ì„œ ì½˜í…ì¸  ë™ê¸°í™”'
        required: false
        default: 'true'
        type: boolean
      deploy:
        description: 'ë°°í¬ ì‹¤í–‰'
        required: false
        default: 'true'
        type: boolean

# ë™ì‹œ ì‹¤í–‰ ë°©ì§€
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  PYTHON_VERSION: '3.11'
  NOTION_DATABASE_ID: ${{ secrets.NOTION_DATABASE_ID }}
  NOTION_COURSES_DB_ID: ${{ secrets.NOTION_COURSES_DB_ID }}

jobs:
  # ============================================================
  # Job 1: Notion ë™ê¸°í™”
  # ============================================================
  sync-notion:
    name: ğŸ“¥ Sync from Notion
    runs-on: ubuntu-latest
    # ìŠ¤ì¼€ì¤„, ìˆ˜ë™ ì‹¤í–‰, ë˜ëŠ” main ë¸Œëœì¹˜ push ì‹œì—ë§Œ ì‹¤í–‰
    if: |
      github.event_name == 'schedule' || 
      github.event_name == 'workflow_dispatch' ||
      (github.event_name == 'push' && github.ref == 'refs/heads/main')
    
    outputs:
      has_changes: ${{ steps.check_changes.outputs.has_changes }}
    
    steps:
      - name: ğŸ“‚ Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: ğŸ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
      
      - name: ğŸ“¦ Install dependencies
        run: |
          pip install --upgrade pip
          pip install notion-client==1.0.0 pyyaml
      
      - name: ğŸ”„ Sync Notion content
        if: |
          github.event_name == 'schedule' || 
          (github.event_name == 'workflow_dispatch' && github.event.inputs.sync_notion == 'true') ||
          github.event_name == 'push'
        env:
          NOTION_API_KEY: ${{ secrets.NOTION_API_KEY }}
        run: |
          echo "ğŸš€ Starting Notion sync..."
          python scripts/sync_notion.py
      
      - name: ğŸ” Check for changes
        id: check_changes
        run: |
          git add -A
          if git diff --staged --quiet; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "ğŸ“­ No changes detected"
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "ğŸ“¬ Changes detected!"
            git diff --staged --stat
          fi
      
      - name: ğŸ’¾ Commit changes
        if: steps.check_changes.outputs.has_changes == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git commit -m "ğŸ”„ Sync content from Notion [skip ci]

          Automated sync at $(date -u +"%Y-%m-%d %H:%M:%S UTC")
          
          Changes:
          $(git diff --staged --stat | head -20)"
          git push

  # ============================================================
  # Job 2: Jupyter Book ë¹Œë“œ
  # ============================================================
  build:
    name: ğŸ”¨ Build Jupyter Book
    runs-on: ubuntu-latest
    needs: [sync-notion]
    # sync-notionì´ ìŠ¤í‚µë˜ì—ˆê±°ë‚˜, ë³€ê²½ì‚¬í•­ì´ ìˆê±°ë‚˜, PRì¸ ê²½ìš° ì‹¤í–‰
    if: |
      always() && 
      (needs.sync-notion.result == 'skipped' || 
       needs.sync-notion.result == 'success')
    
    steps:
      - name: ğŸ“‚ Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ github.ref }}
          # sync-notionì—ì„œ ì»¤ë°‹ì´ ìˆì—ˆì„ ìˆ˜ ìˆìœ¼ë¯€ë¡œ ìµœì‹  ìƒíƒœ ê°€ì ¸ì˜¤ê¸°
          fetch-depth: 0
      
      - name: ğŸ”„ Pull latest changes
        if: github.event_name != 'pull_request'
        run: git pull origin ${{ github.ref_name }} || true
      
      - name: ğŸ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: ğŸ“¦ Install Jupyter Book and dependencies
        run: |
          pip install --upgrade pip
          pip install jupyter-book==0.15.1
          pip install "sphinx<5.1,>=4"
          pip install "docutils<0.19,>=0.15"
          pip install "sphinx-thebe~=0.2.0"
          pip install sphinxcontrib-mermaid==1.2.3
      
      - name: ğŸ”¨ Build Jupyter Book
        run: |
          echo "ğŸ“š Building with Jupyter Book..."
          # myst.yml ë°±ì—… íŒŒì¼ ì‚­ì œ (ì¶©ëŒ ë°©ì§€)
          rm -f myst.yml.bak myst.yml
          jupyter-book build .
          echo "âœ… Build completed!"
          ls -la _build/html/ || echo "No _build/html directory"
      
      - name: ğŸ“Š Build summary
        run: |
          echo "## ğŸ“š Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Item | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Node | 20 |" >> $GITHUB_STEP_SUMMARY
          echo "| Branch | ${{ github.ref_name }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Commit | ${{ github.sha }} |" >> $GITHUB_STEP_SUMMARY
          
          # í˜ì´ì§€ ìˆ˜ ì¹´ìš´íŠ¸
          PAGE_COUNT=$(find _build/html -name "*.html" 2>/dev/null | wc -l || echo "0")
          echo "| Pages | $PAGE_COUNT |" >> $GITHUB_STEP_SUMMARY
      
      - name: ğŸ“¤ Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: jupyter-book-html
          path: _build/html
          retention-days: 7
      
      - name: ğŸ“¤ Upload Pages artifact
        if: github.event_name != 'pull_request'
        uses: actions/upload-pages-artifact@v3
        with:
          path: _build/html

  # ============================================================
  # Job 3: GitHub Pages ë°°í¬
  # ============================================================
  deploy-pages:
    name: ğŸš€ Deploy to GitHub Pages
    runs-on: ubuntu-latest
    needs: [build]
    if: |
      github.event_name != 'pull_request' &&
      (github.event_name != 'workflow_dispatch' || github.event.inputs.deploy == 'true')
    
    permissions:
      pages: write
      id-token: write
    
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    
    steps:
      - name: ğŸš€ Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
      
      - name: ğŸ“ Deployment summary
        run: |
          echo "## ğŸš€ Deployment Complete!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ğŸŒ **URL:** ${{ steps.deployment.outputs.page_url }}" >> $GITHUB_STEP_SUMMARY

  # ============================================================
  # Job 4: PR ë¯¸ë¦¬ë³´ê¸° (ì„ íƒì )
  # ============================================================
  preview:
    name: ğŸ‘€ PR Preview
    runs-on: ubuntu-latest
    needs: [build]
    if: github.event_name == 'pull_request'
    
    steps:
      - name: ğŸ“¥ Download artifact
        uses: actions/download-artifact@v4
        with:
          name: jupyter-book-html
          path: _build/html
      
      - name: ğŸ’¬ Comment on PR
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## ğŸ“š Jupyter Book Build Complete!
              
              âœ… The book has been built successfully.
              
              ğŸ“¦ **Artifact:** Download the build from the workflow run to preview locally.
              
              Run locally:
              \`\`\`bash
              cd _build/html && python -m http.server 8000
              \`\`\`
              Then open http://localhost:8000`
            })
